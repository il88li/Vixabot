import telebot
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton
import requests
import time
import logging
import urllib.parse
from flask import Flask, request, abort

# ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

TOKEN = '8052936091:AAFzLTZ9EQJSWauG9DmGjH2cWzrRx8pOtks'
PIXABAY_API_KEY = '51444506-bffefcaf12816bd85a20222d1'
ADMIN_ID = 6689435577 # Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¯ÙŠØ±
WEBHOOK_URL = 'https://vixabot-3yzy.onrender.com/webhook'  # ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ù‡Ø°Ø§ Ù…Ø¹ Ø¹Ù†ÙˆØ§Ù† URL Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ

app = Flask(__name__)
bot = telebot.TeleBot(TOKEN)

# Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
REQUIRED_CHANNELS = ['@crazys7', '@AWU87']

# Ø°Ø§ÙƒØ±Ø© Ù…Ø¤Ù‚ØªØ© Ù„ØªØ®Ø²ÙŠÙ† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
user_data = {}
new_users = set()  # Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯

def is_valid_url(url):
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¹Ù†ÙˆØ§Ù† URL"""
    try:
        result = urllib.parse.urlparse(url)
        return all([result.scheme, result.netloc])
    except:
        return False

def set_webhook():
    """ØªØ¹ÙŠÙŠÙ† ÙˆÙŠØ¨ Ù‡ÙˆÙƒ Ù„Ù„Ø¨ÙˆØª"""
    try:
        bot.remove_webhook()
        time.sleep(1)
        bot.set_webhook(url=WEBHOOK_URL)
        logger.info("ØªÙ… ØªØ¹ÙŠÙŠÙ† ÙˆÙŠØ¨ Ù‡ÙˆÙƒ Ø¨Ù†Ø¬Ø§Ø­")
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ¹ÙŠÙŠÙ† ÙˆÙŠØ¨ Ù‡ÙˆÙƒ: {e}")

@app.route('/webhook', methods=['POST'])
def webhook():
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ù…Ù† ØªÙ„Ø¬Ø±Ø§Ù…"""
    if request.headers.get('content-type') == 'application/json':
        json_string = request.get_data().decode('utf-8')
        update = telebot.types.Update.de_json(json_string)
        bot.process_new_updates([update])
        return ''
    else:
        abort(403)

@bot.message_handler(commands=['start'])
def send_welcome(message):
    user_id = message.from_user.id
    chat_id = message.chat.id
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    if user_id not in new_users:
        new_users.add(user_id)
        notify_admin(user_id, message.from_user.username)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª
    not_subscribed = check_subscription(user_id)
    
    if not_subscribed:
        markup = InlineKeyboardMarkup()
        # Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù‚Ù†ÙˆØ§Øª
        for channel in REQUIRED_CHANNELS:
            markup.add(InlineKeyboardButton(f"Ø§Ø´ØªØ±Ùƒ ÙÙŠ {channel}", url=f"https://t.me/{channel[1:]}"))
        markup.add(InlineKeyboardButton("ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ", callback_data="check_subscription"))
        msg = bot.send_message(chat_id, "â—ï¸ ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹:\n" + "\n".join([f"â€¢ {channel}" for channel in REQUIRED_CHANNELS]), reply_markup=markup)
        # Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if user_id not in user_data:
            user_data[user_id] = {}
        user_data[user_id]['main_message_id'] = msg.message_id
    else:
        show_main_menu(chat_id, user_id)

def notify_admin(user_id, username):
    """Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø¯ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù†Ø¶Ù…Ø§Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯"""
    try:
        username = f"@{username}" if username else "Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø±Ù"
        message = "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø§Ù†Ø¶Ù… Ù„Ù„Ø¨ÙˆØª:\n\n"
        message += f"ID: {user_id}\n"
        message += f"Username: {username}"
        bot.send_message(ADMIN_ID, message)
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø¯ÙŠØ±: {e}")

def check_subscription(user_id):
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"""
    not_subscribed = []
    for channel in REQUIRED_CHANNELS:
        try:
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©
            chat_member = bot.get_chat_member(chat_id=channel, user_id=user_id)
            if chat_member.status not in ['member', 'administrator', 'creator']:
                not_subscribed.append(channel)
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ {channel}: {e}")
            not_subscribed.append(channel)
    return not_subscribed

def show_main_menu(chat_id, user_id):
    # Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if user_id not in user_data:
        user_data[user_id] = {}
    
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("ğŸ” Ø§Ù†Ù‚Ø± Ù„Ù„Ø¨Ø­Ø«", callback_data="search"))
    markup.add(InlineKeyboardButton("ğŸ‘¤ Ø¹Ù† Ø§Ù„Ù…Ø·ÙˆØ±", callback_data="about_dev"))
    
    welcome_msg = "ğŸ‰ **Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ PEXELBO**\n\nğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©"
    
    # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø±Ø³Ø§Ù„Ø© Ø³Ø§Ø¨Ù‚Ø©ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
    if 'main_message_id' in user_data[user_id]:
        try:
            bot.edit_message_text(
                chat_id=chat_id,
                message_id=user_data[user_id]['main_message_id'],
                text=welcome_msg,
                reply_markup=markup,
                parse_mode='Markdown'
            )
            return
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: {e}")
            # Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ù†Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
            msg = bot.send_message(chat_id, welcome_msg, reply_markup=markup, parse_mode='Markdown')
            user_data[user_id]['main_message_id'] = msg.message_id
    else:
        # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
        msg = bot.send_message(chat_id, welcome_msg, reply_markup=markup, parse_mode='Markdown')
        user_data[user_id]['main_message_id'] = msg.message_id

@bot.callback_query_handler(func=lambda call: call.data == "check_subscription")
def verify_subscription(call):
    user_id = call.from_user.id
    chat_id = call.message.chat.id
    not_subscribed = check_subscription(user_id)
    
    if not_subscribed:
        markup = InlineKeyboardMarkup()
        # Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù‚Ù†ÙˆØ§Øª
        for channel in REQUIRED_CHANNELS:
            markup.add(InlineKeyboardButton(f"Ø§Ø´ØªØ±Ùƒ ÙÙŠ {channel}", url=f"https://t.me/{channel[1:]}"))
        markup.add(InlineKeyboardButton("âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ", callback_data="check_subscription"))
        
        try:
            bot.edit_message_text(
                chat_id=chat_id,
                message_id=call.message.message_id,
                text="âŒ **Ù„Ù… ØªØ´ØªØ±Ùƒ Ø¨Ø¹Ø¯ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:**\n" + "\n".join([f"â€¢ {channel}" for channel in not_subscribed]),
                reply_markup=markup,
                parse_mode='Markdown'
            )
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: {e}")
    else:
        bot.answer_callback_query(call.id, "âœ… ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª.", show_alert=False)
        show_main_menu(chat_id, user_id)

@bot.callback_query_handler(func=lambda call: call.data == "search")
def show_content_types(call):
    user_id = call.from_user.id
    chat_id = call.message.chat.id
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£ÙˆÙ„Ø§Ù‹
    not_subscribed = check_subscription(user_id)
    if not_subscribed:
        bot.answer_callback_query(call.id, "â—ï¸ ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø£ÙˆÙ„Ø§Ù‹", show_alert=True)
        return
    
    # Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø­Ø«
    if user_id not in user_data:
        user_data[user_id] = {}
    
    # Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    try:
        bot.answer_callback_query(call.id)
    except:
        pass
    
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("ğŸ“· Photos", callback_data="type_photo"))
    markup.add(InlineKeyboardButton("ğŸ”º Vectors", callback_data="type_vector"))
    markup.add(InlineKeyboardButton("ğŸ¨ Illustrations", callback_data="type_illustration"))
    markup.add(InlineKeyboardButton("ğŸ¥ Videos", callback_data="type_video"))
    markup.add(InlineKeyboardButton("ğŸŒ All", callback_data="type_all"))
    markup.add(InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main"))
    
    try:
        bot.edit_message_text(
            chat_id=chat_id,
            message_id=call.message.message_id,
            text="ğŸ“‚ **Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰:**",
            reply_markup=markup,
            parse_mode='Markdown'
        )
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: {e}")

@bot.callback_query_handler(func=lambda call: call.data.startswith("type_"))
def request_search_term(call):
    user_id = call.from_user.id
    chat_id = call.message.chat.id
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£ÙˆÙ„Ø§Ù‹
    not_subscribed = check_subscription(user_id)
    if not_subscribed:
        bot.answer_callback_query(call.id, "â—ï¸ ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø£ÙˆÙ„Ø§Ù‹", show_alert=True)
        return
    
    content_type = call.data.split("_")[1]
    
    # ØªØ®Ø²ÙŠÙ† Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø®ØªØ§Ø±
    if user_id not in user_data:
        user_data[user_id] = {}
    user_data[user_id]['content_type'] = content_type
    
    # Ø·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ø²Ø± Ø¥Ù„ØºØ§Ø¡
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("âŒ Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø«", callback_data="cancel_search"))
    
    try:
        bot.edit_message_text(
            chat_id=chat_id,
            message_id=call.message.message_id,
            text="ğŸ” **Ø§Ø±Ø³Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©:**",
            reply_markup=markup,
            parse_mode='Markdown'
        )
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø«: {e}")
    
    # Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹
    user_data[user_id]['search_message_id'] = call.message.message_id
    # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
    bot.register_next_step_handler(call.message, process_search_term, user_id)

@bot.callback_query_handler(func=lambda call: call.data == "cancel_search")
def cancel_search(call):
    user_id = call.from_user.id
    chat_id = call.message.chat.id
    show_main_menu(chat_id, user_id)

def process_search_term(message, user_id):
    chat_id = message.chat.id
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£ÙˆÙ„Ø§Ù‹
    not_subscribed = check_subscription(user_id)
    if not_subscribed:
        show_subscription_required(chat_id, user_id)
        return
    
    search_term = message.text
    
    # Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    try:
        bot.delete_message(chat_id, message.message_id)
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
    
    # Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    if user_id not in user_data or 'content_type' not in user_data[user_id]:
        show_main_menu(chat_id, user_id)
        return
    
    content_type = user_data[user_id]['content_type']
    
    # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    try:
        bot.edit_message_text(
            chat_id=chat_id,
            message_id=user_data[user_id]['search_message_id'],
            text="â³ **Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...**",
            reply_markup=None,
            parse_mode='Markdown'
        )
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„: {e}")
    
    # Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Pixabay
    results = search_pixabay(search_term, content_type)
    
    if not results or 'hits' not in results or len(results['hits']) == 0:
        # Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†ØªØ§Ø¦Ø¬
        markup = InlineKeyboardMarkup()
        markup.add(InlineKeyboardButton("ğŸ” Ø¨Ø­Ø« Ø¬Ø¯ÙŠØ¯", callback_data="search"))
        markup.add(InlineKeyboardButton("ğŸ”™ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_to_main"))
        
        try:
            bot.edit_message_text(
                chat_id=chat_id,
                message_id=user_data[user_id]['search_message_id'],
                text=f"âŒ **Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù„ÙƒÙ„Ù…Ø©:** `{search_term}`\n\nâš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨ÙƒÙ„Ù…Ø§Øª Ø£Ø®Ø±Ù‰",
                reply_markup=markup,
                parse_mode='Markdown'
            )
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†ØªØ§Ø¦Ø¬: {e}")
        return
    
    # Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    user_data[user_id]['search_term'] = search_term
    user_data[user_id]['search_results'] = results['hits']
    user_data[user_id]['current_index'] = 0
    
    # Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙŠ Ù†ÙØ³ Ø±Ø³Ø§Ù„Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«"
    show_result(chat_id, user_id, message_id=user_data[user_id]['search_message_id'])

def show_subscription_required(chat_id, user_id):
    """Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª"""
    markup = InlineKeyboardMarkup()
    for channel in REQUIRED_CHANNELS:
        markup.add(InlineKeyboardButton(f"Ø§Ø´ØªØ±Ùƒ ÙÙŠ {channel}", url=f"https://t.me/{channel[1:]}"))
    markup.add(InlineKeyboardButton("âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ", callback_data="check_subscription"))
    
    bot.send_message(chat_id, "â—ï¸ **ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø£ÙˆÙ„Ø§Ù‹:**\n" + "\n".join([f"â€¢ {channel}" for channel in REQUIRED_CHANNELS]), reply_markup=markup, parse_mode='Markdown')

def search_pixabay(query, content_type):
    base_url = "https://pixabay.com/api/"
    params = {
        'key': PIXABAY_API_KEY,
        'q': query,
        'per_page': 50,
        'lang': 'en'
    }
    
    # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    if content_type == 'photo':
        params['image_type'] = 'photo'
    elif content_type == 'vector':
        params['image_type'] = 'vector'
    elif content_type == 'illustration':
        params['image_type'] = 'photo'
        params['category'] = 'design'
    elif content_type == 'video':
        params['video_type'] = 'all'
        base_url = "https://pixabay.com/api/videos/"
    else:  # all
        params['image_type'] = 'all'
    
    try:
        logger.info(f"Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Pixabay Ø¹Ù†: {query} ({content_type})")
        response = requests.get(base_url, params=params, timeout=15)
        response.raise_for_status()
        data = response.json()
        logger.info(f"ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {len(data.get('hits', []))} Ù†ØªÙŠØ¬Ø©")
        return data
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Pixabay: {e}")
        return None

def show_result(chat_id, user_id, message_id=None):
    if user_id not in user_data or 'search_results' not in user_data[user_id]:
        try:
            bot.edit_message_text(
                chat_id=chat_id,
                message_id=user_data[user_id]['search_message_id'],
                text="â° **Ø§Ù†ØªÙ‡Øª Ø¬Ù„Ø³Ø© Ø§Ù„Ø¨Ø­Ø«ØŒ Ø§Ø¨Ø¯Ø£ Ø¨Ø­Ø«Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹**",
                parse_mode='Markdown'
            )
        except:
            pass
        return
    
    results = user_data[user_id]['search_results']
    current_index = user_data[user_id]['current_index']
    search_term = user_data[user_id].get('search_term', '')
    
    if current_index < 0 or current_index >= len(results):
        try:
            bot.edit_message_text(
                chat_id=chat_id,
                message_id=user_data[user_id]['last_message_id'],
                text="ğŸ **Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬**",
                parse_mode='Markdown'
            )
        except:
            pass
        return
    
    item = results[current_index]
    
    # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    caption = f"ğŸ” **Ø§Ù„Ø¨Ø­Ø«:** {search_term}\n"
    caption += f"ğŸ“Š **Ø§Ù„Ù†ØªÙŠØ¬Ø© {current_index+1} Ù…Ù† {len(results)}**\n"
    if 'tags' in item:
        caption += f"ğŸ·ï¸ **Ø§Ù„ÙˆØ³ÙˆÙ…:** {item['tags']}\n"
    
    # Ø¨Ù†Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„
    markup = InlineKeyboardMarkup()
    row_buttons = []
    if current_index > 0:
        row_buttons.append(InlineKeyboardButton("â—€ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚", callback_data=f"nav_prev"))
    if current_index < len(results) - 1:
        row_buttons.append(InlineKeyboardButton("â–¶ï¸ Ø§Ù„ØªØ§Ù„ÙŠ", callback_data=f"nav_next"))
    
    if row_buttons:
        markup.row(*row_buttons)
    
    markup.add(InlineKeyboardButton("ğŸ“¥ ØªØ­Ù…ÙŠÙ„", callback_data="download"))
    markup.add(InlineKeyboardButton("ğŸ” Ø¨Ø­Ø« Ø¬Ø¯ÙŠØ¯", callback_data="search"))
    markup.add(InlineKeyboardButton("ğŸ”™ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_to_main"))
    
    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    try:
        # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠØ¯ÙŠÙˆ
        if 'videos' in item:
            video_url = item['videos']['medium']['url']
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© URL
            if not is_valid_url(video_url):
                raise ValueError("Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± ØµØ§Ù„Ø­")
            
            # Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            if message_id:
                try:
                    # ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙˆØ§Ù„ØªØ³Ù…ÙŠØ© Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠØ© Ù…Ø¹Ø§Ù‹
                    bot.edit_message_media(
                        chat_id=chat_id,
                        message_id=message_id,
                        media=telebot.types.InputMediaVideo(
                            media=video_url,
                            caption=caption,
                            parse_mode='Markdown'
                        ),
                        reply_markup=markup
                    )
                    # Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                    user_data[user_id]['last_message_id'] = message_id
                    return
                except Exception as e:
                    logger.error(f"ÙØ´Ù„ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: {e}")
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙ†Ø¬Ø­ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            msg = bot.send_video(chat_id, video_url, caption=caption, reply_markup=markup, parse_mode='Markdown')
            user_data[user_id]['last_message_id'] = msg.message_id
        else:
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©
            image_url = item.get('largeImageURL', item.get('webformatURL', ''))
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© URL
            if not is_valid_url(image_url):
                raise ValueError("Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ØºÙŠØ± ØµØ§Ù„Ø­")
            
            # Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            if message_id:
                try:
                    # ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙˆØ§Ù„ØªØ³Ù…ÙŠØ© Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠØ© Ù…Ø¹Ø§Ù‹
                    bot.edit_message_media(
                        chat_id=chat_id,
                        message_id=message_id,
                        media=telebot.types.InputMediaPhoto(
                            media=image_url,
                            caption=caption,
                            parse_mode='Markdown'
                        ),
                        reply_markup=markup
                    )
                    # Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                    user_data[user_id]['last_message_id'] = message_id
                    return
                except Exception as e:
                    logger.error(f"ÙØ´Ù„ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©: {e}")
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙ†Ø¬Ø­ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            msg = bot.send_photo(chat_id, image_url, caption=caption, reply_markup=markup, parse_mode='Markdown')
            user_data[user_id]['last_message_id'] = msg.message_id
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©: {e}")
        # Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ Ù†ØªÙŠØ¬Ø© Ø£Ø®Ø±Ù‰
        user_data[user_id]['current_index'] += 1
        if user_data[user_id]['current_index'] < len(results):
            show_result(chat_id, user_id, message_id)
        else:
            show_no_results(chat_id, user_id)

def show_no_results(chat_id, user_id):
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("ğŸ” Ø¨Ø­Ø« Ø¬Ø¯ÙŠØ¯", callback_data="search"))
    markup.add(InlineKeyboardButton("ğŸ”™ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_to_main"))
    try:
        bot.edit_message_text(
            chat_id=chat_id,
            message_id=user_data[user_id]['search_message_id'],
            text="âŒ **Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù†ØªØ§Ø¦Ø¬**\n\nâš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨ÙƒÙ„Ù…Ø§Øª Ø£Ø®Ø±Ù‰",
            reply_markup=markup,
            parse_mode='Markdown'
        )
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†ØªØ§Ø¦Ø¬: {e}")

@bot.callback_query_handler(func=lambda call: call.data.startswith("nav_"))
def navigate_results(call):
    user_id = call.from_user.id
    chat_id = call.message.chat.id
    action = call.data.split("_")[1]
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£ÙˆÙ„Ø§Ù‹
    not_subscribed = check_subscription(user_id)
    if not_subscribed:
        bot.answer_callback_query(call.id, "â—ï¸ ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø£ÙˆÙ„Ø§Ù‹", show_alert=True)
        return
    
    if user_id not in user_data or 'search_results' not in user_data[user_id]:
        bot.answer_callback_query(call.id, "â° Ø§Ù†ØªÙ‡Øª Ø¬Ù„Ø³Ø© Ø§Ù„Ø¨Ø­Ø«ØŒ Ø§Ø¨Ø¯Ø£ Ø¨Ø­Ø«Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹")
        return
    
    # ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ‡Ø±Ø³
    if action == 'prev':
        user_data[user_id]['current_index'] -= 1
    elif action == 'next':
        user_data[user_id]['current_index'] += 1
    
    # Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ù„ØªÙŠ Ù†Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§)
    user_data[user_id]['last_message_id'] = call.message.message_id
    
    # Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    show_result(chat_id, user_id, message_id=call.message.message_id)

@bot.callback_query_handler(func=lambda call: call.data == "download")
def download_content(call):
    user_id = call.from_user.id
    chat_id = call.message.chat.id
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£ÙˆÙ„Ø§Ù‹
    not_subscribed = check_subscription(user_id)
    if not_subscribed:
        bot.answer_callback_query(call.id, "â—ï¸ ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø£ÙˆÙ„Ø§Ù‹", show_alert=True)
        return
    
    # Ø¥Ø²Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„
    try:
        bot.edit_message_reply_markup(
            chat_id=chat_id,
            message_id=call.message.message_id,
            reply_markup=None
        )
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ø²Ø§Ù„Ø© Ø§Ù„Ø§Ø²Ø±Ø§Ø±: {e}")
    
    # Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
    bot.answer_callback_query(call.id, "âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!", show_alert=False)
    
    # Ø¥Ø¸Ù‡Ø§Ø± Ø®ÙŠØ§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø±Ø³Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø©
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("ğŸ” Ø¨Ø­Ø« Ø¬Ø¯ÙŠØ¯", callback_data="search"))
    markup.add(InlineKeyboardButton("ğŸ”™ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_to_main"))
    
    bot.send_message(chat_id, "âœ… **ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­!**\n\nÙ…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙØ¹Ù„ Ø§Ù„Ø¢Ù†ØŸ", reply_markup=markup, parse_mode='Markdown')

@bot.callback_query_handler(func=lambda call: call.data == "about_dev")
def show_dev_info(call):
    dev_info = """
ğŸ‘¤ **Ø¹Ù† Ø§Ù„Ù…Ø·ÙˆØ±** @Ili8_8ill

Ù…Ø·ÙˆØ± Ù…Ø¨ØªØ¯Ø¦ ÙÙŠ Ø¹Ø§Ù„Ù… Ø¨ÙˆØªØ§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…ØŒ Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙ‡ Ø¨Ø´ØºÙ ÙƒØ¨ÙŠØ± Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© ÙˆØµÙ†Ø§Ø¹Ø© Ø£Ø¯ÙˆØ§Øª Ø°ÙƒÙŠØ© ØªØ³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØªØ¶ÙŠÙ Ù‚ÙŠÙ…Ø© Ù„Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©. ÙŠØ³Ø¹Ù‰ Ù„ØªØ·ÙˆÙŠØ± Ù…Ù‡Ø§Ø±Ø§ØªÙ‡ ÙŠÙˆÙ…Ù‹Ø§ Ø¨Ø¹Ø¯ ÙŠÙˆÙ… Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„ØªØ¬Ø±Ø¨Ø©ØŒ Ø§Ù„ØªØ¹Ù„Ù…ØŒ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø³ÙŠØ·Ø© Ù„ÙƒÙ†Ù‡Ø§ ÙØ¹Ø§Ù„Ø©.

**Ù…Ø§ ÙŠÙ…ÙŠØ²Ù‡ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©:**
- Ø­Ø¨ Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù ÙˆØ§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø°Ø§ØªÙŠ
- Ø¨Ù†Ø§Ø¡ Ø¨ÙˆØªØ§Øª Ø¨Ø³ÙŠØ·Ø© Ø¨Ù…Ù‡Ø§Ù… Ù…Ø­Ø¯Ø¯Ø©
- Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø¯ÙˆØ§Øª Ù…Ø«Ù„ BotFather Ùˆ Python
- Ø§Ù„Ø§Ù†ÙØªØ§Ø­ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø¯ ÙˆØ§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø³ØªÙ…Ø±

**Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©:**
@crazys7 - @AWU87

**Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø·ÙˆØ±:**
Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ù…Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª Ù†Ø­Ùˆ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙØŒ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©ØŒ Ù…Ø¹ Ø·Ù…ÙˆØ­ Ù„ØµÙ†Ø§Ø¹Ø© Ø¨ÙˆØªØ§Øª ØªÙ„Ø¨ÙŠ Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙˆØªØ­Ø¯Ø« ÙØ±Ù‚Ù‹Ø§.

**Ù„Ù„ØªÙˆØ§ØµÙ„:**
ØªØ§Ø¨Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨ @Ili8_8ill
    """
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main"))
    
    try:
        bot.edit_message_text(
            chat_id=call.message.chat.id,
            message_id=call.message.message_id,
            text=dev_info,
            reply_markup=markup,
            parse_mode='Markdown'
        )
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ±: {e}")

@bot.callback_query_handler(func=lambda call: call.data == "back_to_main")
def return_to_main(call):
    user_id = call.from_user.id
    chat_id = call.message.chat.id
    show_main_menu(chat_id, user_id)

if __name__ == '__main__':
    logger.info("Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª...")
    set_webhook()
    app.run(host='0.0.0.0', port=10000)
